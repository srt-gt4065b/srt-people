<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>SRT Admin - ì¤‘ë³µ ë°ì´í„° ì™„ë²½ ì œê±°</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto bg-white p-6 rounded-lg shadow-md">
        <h1 class="text-2xl font-bold mb-4 text-blue-600">SRT Members DB ê´€ë¦¬ì</h1>
        
        <div class="bg-blue-50 p-4 rounded mb-6">
            <p class="text-sm text-blue-800">1. <strong>ì¤‘ë³µ ë°ì´í„° ìŠ¤ìº”</strong>ì„ ëˆ„ë¥´ì„¸ìš”.</p>
            <p class="text-sm text-blue-800 font-bold italic">â€» "ì„±ëª…"ê³¼ "ìƒë…„"ì´ ì™„ë²½íˆ ì¼ì¹˜í•˜ëŠ” ë°ì´í„°ë¥¼ ì°¾ì•„ ì‚­ì œí•©ë‹ˆë‹¤.</p>
        </div>

        <div class="flex gap-2 mb-6">
            <button onclick="scanDuplicates()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">ì¤‘ë³µ ë°ì´í„° ìŠ¤ìº”</button>
            <button id="deleteBtn" onclick="deleteDuplicates()" class="bg-red-500 text-white px-4 py-2 rounded hidden hover:bg-red-600 font-bold">ì¤‘ë³µ ì‚­ì œ ì‹¤í–‰ (DB ë°˜ì˜)</button>
        </div>

        <div id="status" class="mb-4 font-semibold text-lg"></div>
        <div id="resultList" class="space-y-2"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, deleteDoc, doc, query } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCEcu-um43cfv89xX8znl2DYinlR8KHrlU",
            authDomain: "srt-people.firebaseapp.com",
            projectId: "srt-people",
            storageBucket: "srt-people.firebasestorage.app",
            messagingSenderId: "246383141664",
            appId: "1:246383141664:web:bc0f03928643b866f3ad45"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // ğŸ”¥ ë§¤ìš° ì¤‘ìš”: ì‹¤ì œ ë°ì´í„°ê°€ ë“¤ì–´ìˆëŠ” ì „ì²´ ê²½ë¡œ
        const FULL_PATH = "artifacts/srt-people-prod/public/data/srt_members";
        let duplicatesToRemove = [];

        window.scanDuplicates = async () => {
            const status = document.getElementById('status');
            const resultList = document.getElementById('resultList');
            status.innerText = "ì„œë²„ì—ì„œ ìµœì‹  ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘...";
            resultList.innerHTML = "";
            duplicatesToRemove = [];

            try {
                const querySnapshot = await getDocs(collection(db, FULL_PATH));
                const seen = new Map();

                querySnapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    // ì´ë¦„ê³¼ ìƒë…„ ì¡°í•©ìœ¼ë¡œ ì¤‘ë³µ ì²´í¬
                    const uniqueKey = `${data.name}_${data.birthYear}`;

                    if (seen.has(uniqueKey)) {
                        duplicatesToRemove.push({ id: docSnap.id, ...data });
                        const div = document.createElement('div');
                        div.className = "p-3 border-l-4 border-red-500 bg-red-50 text-sm mb-2";
                        div.innerHTML = `
                            <strong>ì¤‘ë³µ ë°œê²¬:</strong> ${data.name} (${data.birthYear}ë…„ìƒ) 
                            <br> ì†Œì†: ${data.group} / ì§€ì—­: ${data.region}
                            <br> <span class="text-xs text-gray-400 font-mono">ID: ${docSnap.id}</span>
                        `;
                        resultList.appendChild(div);
                    } else {
                        seen.set(uniqueKey, docSnap.id);
                    }
                });

                if (duplicatesToRemove.length > 0) {
                    status.innerHTML = `<span class="text-red-600">ì´ ${duplicatesToRemove.length}ê±´ì˜ ì¤‘ë³µ í•­ëª©ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤.</span>`;
                    document.getElementById('deleteBtn').classList.remove('hidden');
                } else {
                    status.innerText = `ìŠ¤ìº” ì™„ë£Œ: ì¤‘ë³µ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. (ì´ ${querySnapshot.size}ëª… ë¶„ì„)`;
                    document.getElementById('deleteBtn').classList.add('hidden');
                }
            } catch (error) {
                console.error(error);
                status.innerText = "ì—ëŸ¬ ë°œìƒ: " + error.message;
            }
        };

        window.deleteDuplicates = async () => {
            if (!confirm(`ì¡°íšŒëœ ${duplicatesToRemove.length}ê°œì˜ ë°ì´í„°ë¥¼ DBì—ì„œ ì˜êµ¬ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            const status = document.getElementById('status');
            let count = 0;

            try {
                for (const item of duplicatesToRemove) {
                    count++;
                    status.innerText = `ì‚­ì œ ì§„í–‰ ì¤‘... (${count}/${duplicatesToRemove.length})`;
                    
                    // ğŸ”¥ ìˆ˜ì •ëœ í¬ì¸íŠ¸: ì¡°íšŒí•  ë•Œì™€ ë™ì¼í•œ ì „ì²´ ê²½ë¡œë¥¼ ì‚¬ìš©í•´ì•¼ ì‚­ì œë©ë‹ˆë‹¤.
                    const docRef = doc(db, FULL_PATH, item.id);
                    await deleteDoc(docRef);
                }

                alert("ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.");
                location.reload();
            } catch (error) {
                console.error(error);
                alert("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message);
            }
        };
    </script>
</body>
</html>

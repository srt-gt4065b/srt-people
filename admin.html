<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>SRT Admin - ë°ì´í„° ì •ì œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto bg-white p-6 rounded-lg shadow-md">
        <h1 class="text-2xl font-bold mb-4 text-blue-600">SRT Members DB ê´€ë¦¬ì</h1>
        
        <div class="bg-blue-50 p-4 rounded mb-6">
            <p class="text-sm text-blue-800 italic">"ì„±ëª…"ê³¼ "ìƒë…„(birthYear)"ì´ ì™„ë²½íˆ ì¼ì¹˜í•˜ëŠ” ë°ì´í„°ë¥¼ ì¤‘ë³µìœ¼ë¡œ ê°„ì£¼í•©ë‹ˆë‹¤.</p>
        </div>

        <div class="flex gap-2 mb-6">
            <button onclick="scanDuplicates()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">ì¤‘ë³µ ë°ì´í„° ìŠ¤ìº”</button>
            <button id="deleteBtn" onclick="deleteDuplicates()" class="bg-red-500 text-white px-4 py-2 rounded hidden hover:bg-red-600">ì¤‘ë³µ ì‚­ì œ ì‹¤í–‰</button>
        </div>

        <div id="status" class="mb-4 font-semibold"></div>
        <div id="resultList" class="space-y-2"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // âš ï¸ ë³¸ì¸ì˜ Firebase ì„¤ì •ê°’ìœ¼ë¡œ êµì²´í•˜ì„¸ìš”
        const firebaseConfig = {
            apiKey: "AIzaSyCEcu-um43cfv89xX8znl2DYinlR8KHrlU",
  authDomain: "srt-people.firebaseapp.com",
  projectId: "srt-people",
  storageBucket: "srt-people.firebasestorage.app",
  messagingSenderId: "246383141664",
  appId: "1:246383141664:web:bc0f03928643b866f3ad45"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        let duplicatesToRemove = [];

        // ... (Firebase ì´ˆê¸°í™” ë¶€ë¶„ì€ ë™ì¼)

window.scanDuplicates = async () => {
    const status = document.getElementById('status');
    const resultList = document.getElementById('resultList');
    status.innerText = "ë°ì´í„° ì¡°íšŒ ì¤‘...";
    resultList.innerHTML = "";
    duplicatesToRemove = [];

    try {
        // ğŸ”¥ ê²½ë¡œ ìˆ˜ì •: ì´ë¯¸ì§€ì— ë‚˜ì˜¨ ì „ì²´ ê²½ë¡œë¥¼ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.
        const membersCollection = collection(db, "artifacts/srt-people-prod/public/data/srt_members");
        const querySnapshot = await getDocs(membersCollection);
        
        console.log("ì¡°íšŒëœ ë¬¸ì„œ ìˆ˜:", querySnapshot.size); // ê°œë°œì ë„êµ¬(F12)ì—ì„œ í™•ì¸ìš©

        const seen = new Map();

        querySnapshot.forEach((docSnap) => {
            const data = docSnap.data();
            // ì¤‘ë³µ ê¸°ì¤€: ì´ë¦„ + ìƒë…„ (í•„ìš”ì‹œ data.phone ë“±ì„ ì¶”ê°€í•˜ì„¸ìš”)
            const uniqueKey = `${data.name}_${data.birthYear}`;

            if (seen.has(uniqueKey)) {
                duplicatesToRemove.push({ id: docSnap.id, ...data });
                const div = document.createElement('div');
                div.className = "p-3 border-l-4 border-red-500 bg-red-50 text-sm mb-2";
                div.innerHTML = `
                    <strong>ì¤‘ë³µ ë°œê²¬:</strong> ${data.name} (${data.birthYear}ë…„ìƒ) 
                    <br> ì†Œì†: ${data.group} / ì§€ì—­: ${data.region}
                    <br> <span class="text-xs text-gray-400">ë¬¸ì„œ ID: ${docSnap.id}</span>
                `;
                resultList.appendChild(div);
            } else {
                seen.set(uniqueKey, docSnap.id);
            }
        });

        if (duplicatesToRemove.length > 0) {
            status.innerHTML = `<span class="text-red-600 font-bold">ì´ ${duplicatesToRemove.length}ê±´ì˜ ì¤‘ë³µ í•­ëª©ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤.</span>`;
            document.getElementById('deleteBtn').classList.remove('hidden');
        } else {
            status.innerText = "ìŠ¤ìº” ì™„ë£Œ: ì¤‘ë³µëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. (ì´ " + querySnapshot.size + "ëª… ë¶„ì„)";
            document.getElementById('deleteBtn').classList.add('hidden');
        }
    } catch (error) {
        console.error("ì—ëŸ¬ ë°œìƒ:", error);
        status.innerText = "ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (F12 ì½˜ì†” í™•ì¸)";
    }
};
        window.deleteDuplicates = async () => {
            if (!confirm("ì •ë§ë¡œ ì¤‘ë³µëœ ë°ì´í„°ë¥¼ DBì—ì„œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")) return;

            const status = document.getElementById('status');
            status.innerText = "ì‚­ì œ ì¤‘...";

            for (const item of duplicatesToRemove) {
                await deleteDoc(doc(db, "srt_members", item.id));
            }

            alert("ì‚­ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
            location.reload();
        };
    </script>
</body>
</html>
